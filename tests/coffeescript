#!/usr/bin/env ruby

# Copyright (c) 2016-2017 Minqi Pan <pmq2001@gmail.com>
# 
# This file is part of Node.js Compiler, distributed under the MIT License
# For full terms see the included LICENSE file

puts `git clone --depth 1 https://github.com/jashkenas/coffeescript.git`
raise 'git failed' unless $?.success?
Dir.chdir('coffeescript')

outfile = Gem.win_platform? ? 'coffee.exe' : 'coffee'
outpath = File.expand_path(outfile, Dir.pwd)

pid = spawn("ruby ../bin/nodec --vcbuild-args=nosign -o #{outfile} bin/coffee")
pid, status = Process.wait2(pid)
raise "Failed running nodec for coffeescript" unless status.success?

raise unless File.exist?(outpath)
raise unless File.size(outpath) >= 10_000_000

if Gem.win_platform?
  outpath = %Q{"#{outpath}"}
else
  File.chmod(0777, outpath)
  outpath = Shellwords.escape(outpath)
end

raise unless `#{outpath} --help`.include?(%q{If called without options, `coffee` will run your script.})
raise unless $?.success?
raise unless 64 == `#{outpath} --eval "console.log(((x) -> x * x)(8))"`.to_i
raise unless $?.success?
